#!/bin/bash
set -e

APP_CONTENTS_DIR="$(cd "$(dirname "$0")/.." && pwd)"
RESOURCE_DIR="${APP_CONTENTS_DIR}/Resources"
APP_SUPPORT_DIR="${HOME}/Library/Application Support/GhostNote"
VENV_DIR="${APP_SUPPORT_DIR}/.venv"
LOG_FILE="${APP_SUPPORT_DIR}/ghostnote.log"

mkdir -p "${APP_SUPPORT_DIR}"

if ! command -v python3 >/dev/null 2>&1; then
  /usr/bin/osascript -e 'display dialog "Python 3 is required to run GhostNote. Install Python 3 and try again." buttons {"OK"} default button "OK"'
  exit 1
fi

{
  echo ""
  echo "---- GhostNote launch $(date) ----"
  echo "Resources: ${RESOURCE_DIR}"
} >> "${LOG_FILE}"

if [ ! -x "${VENV_DIR}/bin/python" ]; then
  echo "Creating virtualenv..." >> "${LOG_FILE}"
  python3 -m venv "${VENV_DIR}" >> "${LOG_FILE}" 2>&1 || {
    /usr/bin/osascript -e 'display dialog "Failed to create the virtual environment. See ghostnote.log for details." buttons {"OK"} default button "OK"'
    exit 1
  }
fi

echo "Installing dependencies..." >> "${LOG_FILE}"
"${VENV_DIR}/bin/pip" install --upgrade pip >> "${LOG_FILE}" 2>&1 || true
"${VENV_DIR}/bin/pip" install -r "${RESOURCE_DIR}/requirements.txt" >> "${LOG_FILE}" 2>&1 || {
  /usr/bin/osascript -e 'display dialog "Failed to install dependencies. See ghostnote.log for details." buttons {"OK"} default button "OK"'
  exit 1
}

echo "Starting GhostNote..." >> "${LOG_FILE}"
exec "${VENV_DIR}/bin/python" "${RESOURCE_DIR}/app.py" >> "${LOG_FILE}" 2>&1
